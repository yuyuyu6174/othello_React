(function(){"use strict";function y(e,t){return t*8+e}const F=[[1,0],[-1,0],[0,1],[0,-1],[1,1],[-1,-1],[1,-1],[-1,1]];function G(e,t,n,o){if(o[y(e,t)]!==0)return[];const i=[],r=3-n;for(const[a,f]of F){let l=e+a,u=t+f;const m=[];for(;l>=0&&l<8&&u>=0&&u<8&&o[y(l,u)]===r;)m.push([l,u]),l+=a,u+=f;l>=0&&l<8&&u>=0&&u<8&&o[y(l,u)]===n&&i.push(...m)}return i}function H(e,t){const n=[];for(let o=0;o<8;o++)for(let i=0;i<8;i++){const r=G(i,o,e,t);r.length>0&&n.push({x:i,y:o,flips:r})}return n}function S(e,t){return H(e,t)}function w(e,t,n){const o=e.slice();o[y(t.x,t.y)]=n;for(const[i,r]of t.flips)o[y(i,r)]=n;return o}function Z(e){let t=0,n=0;for(let o=0;o<8*8;o++){const i=e[o];i===1?t++:i===2&&n++}return{black:t,white:n}}function E(e,t,n){const o=[],i=y(t.x,t.y);o.push({idx:i,prev:e[i]}),e[i]=n;for(const[r,a]of t.flips){const f=y(r,a);o.push({idx:f,prev:e[f]}),e[f]=n}return o}function T(e,t){for(const{idx:n,prev:o}of t)e[n]=o}function K(e){let t=0,n=0;for(let o=0;o<e.length;o++){const i=e[o];i===W?t++:i===B&&n++}return{white:t,black:n}}function O(e){const t=Array.from({length:d},()=>Array(d).fill(0)),n=[[1,0],[-1,0],[0,1],[0,-1],[1,1],[-1,-1],[1,-1],[-1,1]],o=(i,r,a)=>{for(let[f,l]of n){let u=i+f,m=r+l;for(;u>=0&&u<d&&m>=0&&m<d;){if(e[y(u,m)]!==a)return!1;u+=f,m+=l}}return!0};for(let i=0;i<d;i++)for(let r=0;r<d;r++){const a=e[y(r,i)];a!==b&&o(r,i,a)&&(t[i][r]=a)}return t}function k(e,t){const n=3-t;let o=0;for(let i=0;i<d;i++)for(let r=0;r<d;r++){const a=e[y(r,i)];a===t?o++:a===n&&o--}return o}function P(e,t,n={}){return L(e,t,n)}function $(e,t,n={}){return L(e,t,n)}function L(e,t,n={}){const o=3-t;let i=0;const r=n.weights??g.weights,a=n.useWeights!==!1,f=n.stableStoneBonus??g.stableStoneBonus,l=n.parityWeight??g.parityWeight,u=n.xSquarePenalty??g.xSquarePenalty,m=n.trapPenalty??g.trapPenalty;if(a)for(let p=0;p<d;p++)for(let s=0;s<d;s++){const c=e[y(s,p)];c===t?i+=r[p][s]:c===o&&(i-=r[p][s])}if(n.evaluateStableStones){const p=O(e);for(let s=0;s<d;s++)for(let c=0;c<d;c++)p[s][c]===t?i+=f:p[s][c]===o&&(i-=f)}if(n.considerParity){let p=0;for(let s=0;s<e.length;s++)e[s]===b&&p++;if(p<=16){const s=K(e),c=t===W?s.white-s.black:s.black-s.white;i+=l*Math.sign(c)}}if(n.penalizeXSquare){const p=[[1,1],[6,1],[1,6],[6,6]];for(const[s,c]of p)e[y(s,c)]===t&&(i-=u),e[y(s,c)]===o&&(i+=u)}if(n.avoidCornerTrap){const p=[[0,1],[1,0],[1,1],[0,6],[1,7],[1,6],[6,0],[6,1],[7,1],[6,6],[6,7],[7,6]];for(const[s,c]of p)e[y(s,c)]===t&&(i-=m),e[y(s,c)]===o&&(i+=m)}return i}const d=8,b=0,B=1,W=2,g={visible:!0,depth:2,weights:[[100,-25,10,5,5,10,-25,100],[-25,-50,1,1,1,1,-50,-25],[10,1,3,2,2,3,1,10],[5,1,2,1,1,2,1,5],[5,1,2,1,1,2,1,5],[10,1,3,2,2,3,1,10],[-25,-50,1,1,1,1,-50,-25],[100,-25,10,5,5,10,-25,100]],parityWeight:40,stableStoneBonus:20,xSquarePenalty:30,trapPenalty:30,endgame:{maxEmpty:12,usePruning:!0}},X={1:{visible:!0,name:"弱",comment:"浅い読みとシンプルな評価（初心者向け）",type:"minimax",depth:1,evaluator:k},2:{visible:!0,name:"中",comment:"標準的な深さのミニマックス探索",type:"minimax",depth:2,evaluator:k},3:{visible:!0,name:"強",comment:"さらに深い探索で安定したプレイ",type:"minimax",depth:3,evaluator:k},4:{visible:!0,name:"最強",comment:"深さ6の高精度ミニマックス探索（実践向け）",type:"minimax",depth:6,evaluator:P,useWeights:!1,avoidCornerTrap:!0,penalizeXSquare:!0},101:{visible:!0,name:"AI Test1",comment:"戦略評価を導入",type:"minimax",depth:8,evaluator:P,useWeights:!0,avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0},102:{visible:!0,name:"AI Test2",comment:"残りマス数に応じて深さを調整（動的読み）",type:"minimax",dynamicDepth:!0,depthTable:[{max:20,depth:7},{max:40,depth:5},{max:64,depth:4}],evaluator:P,useWeights:!0,avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0},103:{visible:!0,name:"AI Test3",comment:"反復深化探索（時間制限あり）",type:"iterative",timeLimit:1e3,evaluator:P,useWeights:!0,avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0},104:{visible:!0,name:"AI Test4",comment:"MCTS（モンテカルロ木探索）を使用",type:"mcts",simulations:1e3,timeLimit:800,explorationConstant:1.1,evaluator:$,useWeights:!0,avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0,parityWeight:50,stableStoneBonus:30,xSquarePenalty:60},105:{visible:!1,name:"AI Test5",comment:"評価カスタムを実装",type:"minimax",dynamicDepth:!0,depthTable:[{max:20,depth:8},{max:40,depth:6},{max:64,depth:5}],evaluator:$,useWeights:!0,weights:[[100,-40,20,5,5,20,-40,100],[-40,-80,-1,-1,-1,-1,-80,-40],[20,-1,5,1,1,5,-1,20],[5,-1,1,0,0,1,-1,5],[5,-1,1,0,0,1,-1,5],[20,-1,5,1,1,5,-1,20],[-40,-80,-1,-1,-1,-1,-80,-40],[100,-40,20,5,5,20,-40,100]],avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0,parityWeight:40,stableStoneBonus:20,xSquarePenalty:50,useEndgameSolver:!0,endgame:{maxEmpty:12,usePruning:!0}},106:{visible:!0,name:"AI Test6",comment:"残り12マスになると完全終局読みを使用",type:"minimax",dynamicDepth:!0,depthTable:[{max:20,depth:8},{max:40,depth:6},{max:64,depth:5}],evaluator:P,useWeights:!0,avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0,useEndgameSolver:!0,endgame:{maxEmpty:12,usePruning:!0}},999:{visible:!0,name:"Noob",comment:"最深読みと戦略フル活用。",type:"minimax",dynamicDepth:!0,depthTable:[{max:20,depth:10},{max:40,depth:8},{max:64,depth:6}],evaluator:$,useWeights:!0,weights:[[100,-40,20,5,5,20,-40,100],[-40,-80,-1,-1,-1,-1,-80,-40],[20,-1,5,1,1,5,-1,20],[5,-1,1,0,0,1,-1,5],[5,-1,1,0,0,1,-1,5],[20,-1,5,1,1,5,-1,20],[-40,-80,-1,-1,-1,-1,-80,-40],[100,-40,20,5,5,20,-40,100]],avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0,parityWeight:60,stableStoneBonus:30,xSquarePenalty:60,trapPenalty:40,useEndgameSolver:!0,endgame:{maxEmpty:14,usePruning:!0}}},C=new Map,A=new Map;function z(e){let t="";for(let n=0;n<e.length;n++)t+=e[n];return t}function V(e,t){const n=S(t,e);for(const o of n){const i=w(e,o,t),{black:r,white:a}=Z(i);if(t===B&&a===0||t===W&&r===0)return o}return null}function v(e){if(e!=null&&e.aborted)throw new DOMException("aborted","AbortError")}function Y(e,t,n,o){v(o);const i=X[n]||X[1],r={...g,...i,endgame:{...g.endgame,...i.endgame||{}}},a=u=>r.evaluator(u,t,r);let f=0;for(let u=0;u<e.length;u++)e[u]===b&&f++;const l=V(e,t);if(l)return l;if(r.useEndgameSolver&&r.endgame&&f<=(r.endgame.maxEmpty??12))return Q(e,t,r);if(r.type==="minimax"){const u=r.dynamicDepth?U(f,r.depthTable||[]):r.depth??g.depth??2;return j(e,t,u,a,r,o)}return r.type==="iterative"?J(e,t,r.timeLimit||1e3,a,r,o):r.type==="mcts"?te(e,t,r,o):null}function U(e,t){for(let n of t)if(e<=n.max)return n.depth;return 2}function j(e,t,n,o,i,r){v(r);const a=S(t,e);if(a.length===0)return null;let f=null,l=-1/0;for(const u of a){const m=E(e,u,t);v(r);const p=q(e,3-t,n-1,-1/0,1/0,!1,o,i,r);T(e,m),p>l&&(l=p,f=u)}return f}function q(e,t,n,o,i,r,a,f,l){v(l);const u=z(e)+t+n;if(C.has(u))return C.get(u);const m=S(t,e);if(n===0||m.length===0){const s=a(e);return C.set(u,s),s}const p=m.map(s=>{const c=w(e,s,t),h=a(c);return{move:s,score:h}}).sort((s,c)=>r?c.score-s.score:s.score-c.score);if(r){let s=-1/0;for(const{move:c}of p){const h=E(e,c,t);v(l);const I=q(e,3-t,n-1,o,i,!1,a,f,l);if(T(e,h),s=Math.max(s,I),o=Math.max(o,I),i<=o)break}return C.set(u,s),s}else{let s=1/0;for(const{move:c}of p){const h=E(e,c,t);v(l);const I=q(e,3-t,n-1,o,i,!0,a,f,l);if(T(e,h),s=Math.min(s,I),i=Math.min(i,I),i<=o)break}return C.set(u,s),s}}function J(e,t,n,o,i,r){v(r);const a=S(t,e);let f=null,l=-1/0;const u=Date.now();let m=1;for(;Date.now()-u<n;){v(r);for(const p of a){v(r);const s=E(e,p,t),c=q(e,3-t,m,-1/0,1/0,!1,o,i,r);T(e,s),c>l&&(l=c,f=p)}m++}return f}function Q(e,t,n,o){v(o);const i=S(t,e);if(i.length===0)return null;let r=null,a=-1/0;const f=i.map(l=>{const u=w(e,l,t),m=n.evaluator(u,t,n);return{move:l,score:m}}).sort((l,u)=>u.score-l.score);for(const{move:l}of f){v(o);const u=E(e,l,t),m=-D(e,3-t,n,!1,-1/0,1/0,o);T(e,u),m>a&&(a=m,r=l)}return r}function D(e,t,n,o,i=-1/0,r=1/0,a){var p;v(a);const f=z(e)+t;if(A.has(f))return A.get(f);const l=S(t,e);if(l.length===0)if(S(3-t,e).length===0){let c=0,h=0;for(let M=0;M<e.length;M++)e[M]===B?c++:e[M]===W&&h++;const I=t===B?c-h:h-c;return A.set(f,I),I}else{const c=-D(e,3-t,n,!0,-r,-i,a);return A.set(f,c),c}const u=l.map(s=>{const c=w(e,s,t),h=n.evaluator(c,t,n);return{move:s,score:h}}).sort((s,c)=>c.score-s.score);let m=-1/0;for(const{move:s}of u){const c=E(e,s,t);v(a);const h=-D(e,3-t,n,!1,-r,-i,a);if(T(e,c),m=Math.max(m,h),i=Math.max(i,h),i>=r||(p=n.endgame)!=null&&p.usePruning&&m>=64)break}return A.set(f,m),m}function R(e,t){let n=-1/0,o=e.children[0];for(const i of e.children){const r=i.visits===0?1/0:i.wins/i.visits+t*Math.sqrt(Math.log(e.visits)/i.visits);r>n&&(n=r,o=i)}return o}function ee(e,t,n,o){v(o);let i=e.slice(),r=t;for(;;){v(o);const l=S(r,i);if(l.length===0){if(S(3-r,i).length===0)break;r=3-r;continue}const u=l[Math.floor(Math.random()*l.length)];i=w(i,u,r),r=3-r}const{black:a,white:f}=Z(i);return n===B?a>f?1:a===f?.5:0:f>a?1:f===a?.5:0}function te(e,t,n,o){const i=n.timeLimit??1e3,r=n.simulations??1e3,a=n.explorationConstant??1.4,f={board:e,children:[],untried:S(t,e),wins:0,visits:0,color:t},l=Date.now();let u=0;for(;Date.now()-l<i&&u<r;){v(o);let s=f;for(;s.untried.length===0&&s.children.length>0;)s=R(s,a);if(s.untried.length>0){const I=Math.floor(Math.random()*s.untried.length),M=s.untried.splice(I,1)[0],N=w(s.board,M,s.color),_={board:N,move:M,parent:s,children:[],untried:S(3-s.color,N),wins:0,visits:0,color:3-s.color};s.children.push(_),s=_}const c=ee(s.board,s.color,t,o);let h=s;for(;h;)h.visits+=1,h.wins+=c,h=h.parent;u++}let m=null,p=-1;for(const s of f.children)s.visits>p&&(p=s.visits,m=s.move??null);return m}let x=null;self.onmessage=function(e){const t=e.data;if(t.type==="abort"){x==null||x.abort(),x=null;return}if(t.type==="start"){x==null||x.abort(),x=new AbortController;try{const n=Y(t.board,t.turn,t.level,x.signal);postMessage(n)}catch(n){if(n.name!=="AbortError")throw n}finally{x=null}}}})();
