(function(){"use strict";function h(e,t){return t*8+e}const z=[[1,0],[-1,0],[0,1],[0,-1],[1,1],[-1,-1],[1,-1],[-1,1]];function b(e,t,i,s){if(s[h(e,t)]!==0)return[];const n=[],u=3-i;for(const[a,l]of z){let f=e+a,c=t+l;const p=[];for(;f>=0&&f<8&&c>=0&&c<8&&s[h(f,c)]===u;)p.push([f,c]),f+=a,c+=l;f>=0&&f<8&&c>=0&&c<8&&s[h(f,c)]===i&&n.push(...p)}return n}function N(e,t){const i=[];for(let s=0;s<8;s++)for(let n=0;n<8;n++){const u=b(n,s,e,t);u.length>0&&i.push({x:n,y:s,flips:u})}return i}function y(e,t){return N(e,t)}function M(e,t,i){const s=e.slice();s[h(t.x,t.y)]=i;for(const[n,u]of t.flips)s[h(n,u)]=i;return s}function _(e){let t=0,i=0;for(let s=0;s<8*8;s++){const n=e[s];n===1?t++:n===2&&i++}return{black:t,white:i}}function g(e,t,i){const s=[],n=h(t.x,t.y);s.push({idx:n,prev:e[n]}),e[n]=i;for(const[u,a]of t.flips){const l=h(u,a);s.push({idx:l,prev:e[l]}),e[l]=i}return s}function I(e,t){for(const{idx:i,prev:s}of t)e[i]=s}function F(e){let t=0,i=0;for(let s=0;s<e.length;s++){const n=e[s];n===q?t++:n===P&&i++}return{white:t,black:i}}function G(e){const t=Array.from({length:v},()=>Array(v).fill(0)),i=[[1,0],[-1,0],[0,1],[0,-1],[1,1],[-1,-1],[1,-1],[-1,1]],s=(n,u,a)=>{for(let[l,f]of i){let c=n+l,p=u+f;for(;c>=0&&c<v&&p>=0&&p<v;){if(e[h(c,p)]!==a)return!1;c+=l,p+=f}}return!0};for(let n=0;n<v;n++)for(let u=0;u<v;u++){const a=e[h(u,n)];a!==k&&s(u,n,a)&&(t[n][u]=a)}return t}function C(e,t){const i=3-t;let s=0;for(let n=0;n<v;n++)for(let u=0;u<v;u++){const a=e[h(u,n)];a===t?s++:a===i&&s--}return s}function T(e,t,i={}){return A(e,t,i)}function W(e,t,i={}){return A(e,t,i)}function A(e,t,i={}){const s=3-t;let n=0;const u=i.weights??S.weights,a=i.useWeights!==!1,l=i.stableStoneBonus??S.stableStoneBonus,f=i.parityWeight??S.parityWeight,c=i.xSquarePenalty??S.xSquarePenalty,p=i.trapPenalty??S.trapPenalty;if(a)for(let r=0;r<v;r++)for(let o=0;o<v;o++){const m=e[h(o,r)];m===t?n+=u[r][o]:m===s&&(n-=u[r][o])}if(i.evaluateStableStones){const r=G(e);for(let o=0;o<v;o++)for(let m=0;m<v;m++)r[o][m]===t?n+=l:r[o][m]===s&&(n-=l)}if(i.considerParity){let r=0;for(let o=0;o<e.length;o++)e[o]===k&&r++;if(r<=16){const o=F(e),m=t===q?o.white-o.black:o.black-o.white;n+=f*Math.sign(m)}}if(i.penalizeXSquare){const r=[[1,1],[6,1],[1,6],[6,6]];for(const[o,m]of r)e[h(o,m)]===t&&(n-=c),e[h(o,m)]===s&&(n+=c)}if(i.avoidCornerTrap){const r=[[0,1],[1,0],[1,1],[0,6],[1,7],[1,6],[6,0],[6,1],[7,1],[6,6],[6,7],[7,6]];for(const[o,m]of r)e[h(o,m)]===t&&(n-=p),e[h(o,m)]===s&&(n+=p)}return n}const v=8,k=0,P=1,q=2,S={visible:!0,depth:2,weights:[[100,-25,10,5,5,10,-25,100],[-25,-50,1,1,1,1,-50,-25],[10,1,3,2,2,3,1,10],[5,1,2,1,1,2,1,5],[5,1,2,1,1,2,1,5],[10,1,3,2,2,3,1,10],[-25,-50,1,1,1,1,-50,-25],[100,-25,10,5,5,10,-25,100]],parityWeight:40,stableStoneBonus:20,xSquarePenalty:30,trapPenalty:30,endgame:{maxEmpty:12,usePruning:!0}},D={1:{visible:!0,name:"弱",comment:"浅い読みとシンプルな評価（初心者向け）",type:"minimax",depth:1,evaluator:C},2:{visible:!0,name:"中",comment:"標準的な深さのミニマックス探索",type:"minimax",depth:2,evaluator:C},3:{visible:!0,name:"強",comment:"さらに深い探索で安定したプレイ",type:"minimax",depth:3,evaluator:C},4:{visible:!0,name:"最強",comment:"深さ6の高精度ミニマックス探索（実践向け）",type:"minimax",depth:6,evaluator:T,useWeights:!1,avoidCornerTrap:!0,penalizeXSquare:!0},101:{visible:!0,name:"AI Test1",comment:"戦略評価を導入",type:"minimax",depth:8,evaluator:T,useWeights:!0,avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0},102:{visible:!0,name:"AI Test2",comment:"残りマス数に応じて深さを調整（動的読み）",type:"minimax",dynamicDepth:!0,depthTable:[{max:20,depth:7},{max:40,depth:5},{max:64,depth:4}],evaluator:T,useWeights:!0,avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0},103:{visible:!0,name:"AI Test3",comment:"反復深化探索（時間制限あり）",type:"iterative",timeLimit:1e3,evaluator:T,useWeights:!0,avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0},104:{visible:!0,name:"AI Test4",comment:"MCTS（モンテカルロ木探索）を使用",type:"mcts",simulations:1e3,timeLimit:800,explorationConstant:1.1,evaluator:W,useWeights:!0,avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0,parityWeight:50,stableStoneBonus:30,xSquarePenalty:60},105:{visible:!1,name:"AI Test5",comment:"評価カスタムを実装",type:"minimax",dynamicDepth:!0,depthTable:[{max:20,depth:8},{max:40,depth:6},{max:64,depth:5}],evaluator:W,useWeights:!0,weights:[[100,-40,20,5,5,20,-40,100],[-40,-80,-1,-1,-1,-1,-80,-40],[20,-1,5,1,1,5,-1,20],[5,-1,1,0,0,1,-1,5],[5,-1,1,0,0,1,-1,5],[20,-1,5,1,1,5,-1,20],[-40,-80,-1,-1,-1,-1,-80,-40],[100,-40,20,5,5,20,-40,100]],avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0,parityWeight:40,stableStoneBonus:20,xSquarePenalty:50,useEndgameSolver:!0,endgame:{maxEmpty:12,usePruning:!0}},106:{visible:!0,name:"AI Test6",comment:"残り12マスになると完全終局読みを使用",type:"minimax",dynamicDepth:!0,depthTable:[{max:20,depth:8},{max:40,depth:6},{max:64,depth:5}],evaluator:T,useWeights:!0,avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0,useEndgameSolver:!0,endgame:{maxEmpty:12,usePruning:!0}},999:{visible:!0,name:"Noob",comment:"最深読みと戦略フル活用。",type:"minimax",dynamicDepth:!0,depthTable:[{max:20,depth:10},{max:40,depth:8},{max:64,depth:6}],evaluator:W,useWeights:!0,weights:[[100,-40,20,5,5,20,-40,100],[-40,-80,-1,-1,-1,-1,-80,-40],[20,-1,5,1,1,5,-1,20],[5,-1,1,0,0,1,-1,5],[5,-1,1,0,0,1,-1,5],[20,-1,5,1,1,5,-1,20],[-40,-80,-1,-1,-1,-1,-80,-40],[100,-40,20,5,5,20,-40,100]],avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0,parityWeight:60,stableStoneBonus:30,xSquarePenalty:60,trapPenalty:40,useEndgameSolver:!0,endgame:{maxEmpty:14,usePruning:!0}}},w=new Map,E=new Map;function Z(e){let t="";for(let i=0;i<e.length;i++)t+=e[i];return t}function H(e,t,i){const s=D[i]||D[1],n={...S,...s,endgame:{...S.endgame,...s.endgame||{}}},u=l=>n.evaluator(l,t,n);let a=0;for(let l=0;l<e.length;l++)e[l]===0&&a++;if(n.useEndgameSolver&&n.endgame&&a<=(n.endgame.maxEmpty??12))return O(e,t,n);if(n.type==="minimax"){const l=n.dynamicDepth?K(a,n.depthTable||[]):n.depth??S.depth??2;return V(e,t,l,u)}return n.type==="iterative"?Y(e,t,n.timeLimit||1e3,u):n.type==="mcts"?J(e,t,n):null}function K(e,t){for(let i of t)if(e<=i.max)return i.depth;return 2}function V(e,t,i,s,n){const u=y(t,e);if(u.length===0)return null;let a=null,l=-1/0;for(const f of u){const c=g(e,f,t),p=B(e,3-t,i-1,-1/0,1/0,!1,s);I(e,c),p>l&&(l=p,a=f)}return a}function B(e,t,i,s,n,u,a,l){const f=Z(e)+t+i;if(w.has(f))return w.get(f);const c=y(t,e);if(i===0||c.length===0){const r=a(e);return w.set(f,r),r}const p=c.map(r=>{const o=M(e,r,t),m=a(o);return{move:r,score:m}}).sort((r,o)=>u?o.score-r.score:r.score-o.score);if(u){let r=-1/0;for(const{move:o}of p){const m=g(e,o,t),d=B(e,3-t,i-1,s,n,!1,a);if(I(e,m),r=Math.max(r,d),s=Math.max(s,d),n<=s)break}return w.set(f,r),r}else{let r=1/0;for(const{move:o}of p){const m=g(e,o,t),d=B(e,3-t,i-1,s,n,!0,a);if(I(e,m),r=Math.min(r,d),n=Math.min(n,d),n<=s)break}return w.set(f,r),r}}function Y(e,t,i,s,n){const u=y(t,e);let a=null,l=-1/0;const f=Date.now();let c=1;for(;Date.now()-f<i;){for(const p of u){const r=g(e,p,t),o=B(e,3-t,c,-1/0,1/0,!1,s);I(e,r),o>l&&(l=o,a=p)}c++}return a}function O(e,t,i){const s=y(t,e);if(s.length===0)return null;let n=null,u=-1/0;const a=s.map(l=>{const f=M(e,l,t),c=i.evaluator(f,t,i);return{move:l,score:c}}).sort((l,f)=>f.score-l.score);for(const{move:l}of a){const f=g(e,l,t),c=-$(e,3-t,i,!1,-1/0,1/0);I(e,f),c>u&&(u=c,n=l)}return n}function $(e,t,i,s,n=-1/0,u=1/0){var p;const a=Z(e)+t;if(E.has(a))return E.get(a);const l=y(t,e);if(l.length===0)if(y(3-t,e).length===0){let o=0,m=0;for(let x=0;x<e.length;x++)e[x]===P?o++:e[x]===q&&m++;const d=t===P?o-m:m-o;return E.set(a,d),d}else{const o=-$(e,3-t,i,!0,-u,-n);return E.set(a,o),o}const f=l.map(r=>{const o=M(e,r,t),m=i.evaluator(o,t,i);return{move:r,score:m}}).sort((r,o)=>o.score-r.score);let c=-1/0;for(const{move:r}of f){const o=g(e,r,t),m=-$(e,3-t,i,!1,-u,-n);if(I(e,o),c=Math.max(c,m),n=Math.max(n,m),n>=u||(p=i.endgame)!=null&&p.usePruning&&c>=64)break}return E.set(a,c),c}function U(e,t){let i=-1/0,s=e.children[0];for(const n of e.children){const u=n.visits===0?1/0:n.wins/n.visits+t*Math.sqrt(Math.log(e.visits)/n.visits);u>i&&(i=u,s=n)}return s}function j(e,t,i){let s=e.slice(),n=t;for(;;){const l=y(n,s);if(l.length===0){if(y(3-n,s).length===0)break;n=3-n;continue}const f=l[Math.floor(Math.random()*l.length)];s=M(s,f,n),n=3-n}const{black:u,white:a}=_(s);return i===P?u>a?1:u===a?.5:0:a>u?1:a===u?.5:0}function J(e,t,i){const s=i.timeLimit??1e3,n=i.simulations??1e3,u=i.explorationConstant??1.4,a={board:e,children:[],untried:y(t,e),wins:0,visits:0,color:t},l=Date.now();let f=0;for(;Date.now()-l<s&&f<n;){let r=a;for(;r.untried.length===0&&r.children.length>0;)r=U(r,u);if(r.untried.length>0){const d=Math.floor(Math.random()*r.untried.length),x=r.untried.splice(d,1)[0],L=M(r.board,x,r.color),X={board:L,move:x,parent:r,children:[],untried:y(3-r.color,L),wins:0,visits:0,color:3-r.color};r.children.push(X),r=X}const o=j(r.board,r.color,t);let m=r;for(;m;)m.visits+=1,m.wins+=o,m=m.parent;f++}let c=null,p=-1;for(const r of a.children)r.visits>p&&(p=r.visits,c=r.move??null);return c}self.onmessage=function(e){const{board:t,turn:i,level:s}=e.data,n=H(t,i,s);postMessage(n)}})();
