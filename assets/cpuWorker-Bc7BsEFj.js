(function(){"use strict";function h(e,t){return t*8+e}const b=[[1,0],[-1,0],[0,1],[0,-1],[1,1],[-1,-1],[1,-1],[-1,1]];function N(e,t,i,s){if(s[h(e,t)]!==0)return[];const n=[],o=3-i;for(const[a,c]of b){let l=e+a,f=t+c;const p=[];for(;l>=0&&l<8&&f>=0&&f<8&&s[h(l,f)]===o;)p.push([l,f]),l+=a,f+=c;l>=0&&l<8&&f>=0&&f<8&&s[h(l,f)]===i&&n.push(...p)}return n}function _(e,t){const i=[];for(let s=0;s<8;s++)for(let n=0;n<8;n++){const o=N(n,s,e,t);o.length>0&&i.push({x:n,y:s,flips:o})}return i}function y(e,t){return _(e,t)}function g(e,t,i){const s=e.slice();s[h(t.x,t.y)]=i;for(const[n,o]of t.flips)s[h(n,o)]=i;return s}function k(e){let t=0,i=0;for(let s=0;s<8*8;s++){const n=e[s];n===1?t++:n===2&&i++}return{black:t,white:i}}function I(e,t,i){const s=[],n=h(t.x,t.y);s.push({idx:n,prev:e[n]}),e[n]=i;for(const[o,a]of t.flips){const c=h(o,a);s.push({idx:c,prev:e[c]}),e[c]=i}return s}function M(e,t){for(const{idx:i,prev:s}of t)e[i]=s}function F(e){let t=0,i=0;for(let s=0;s<e.length;s++){const n=e[s];n===B?t++:n===w&&i++}return{white:t,black:i}}function G(e){const t=Array.from({length:v},()=>Array(v).fill(0)),i=[[1,0],[-1,0],[0,1],[0,-1],[1,1],[-1,-1],[1,-1],[-1,1]],s=(n,o,a)=>{for(let[c,l]of i){let f=n+c,p=o+l;for(;f>=0&&f<v&&p>=0&&p<v;){if(e[h(f,p)]!==a)return!1;f+=c,p+=l}}return!0};for(let n=0;n<v;n++)for(let o=0;o<v;o++){const a=e[h(o,n)];a!==D&&s(o,n,a)&&(t[n][o]=a)}return t}function W(e,t){const i=3-t;let s=0;for(let n=0;n<v;n++)for(let o=0;o<v;o++){const a=e[h(o,n)];a===t?s++:a===i&&s--}return s}function T(e,t,i={}){return A(e,t,i)}function q(e,t,i={}){return A(e,t,i)}function A(e,t,i={}){const s=3-t;let n=0;const o=i.weights??S.weights,a=i.useWeights!==!1,c=i.stableStoneBonus??S.stableStoneBonus,l=i.parityWeight??S.parityWeight,f=i.xSquarePenalty??S.xSquarePenalty,p=i.trapPenalty??S.trapPenalty;if(a)for(let r=0;r<v;r++)for(let u=0;u<v;u++){const m=e[h(u,r)];m===t?n+=o[r][u]:m===s&&(n-=o[r][u])}if(i.evaluateStableStones){const r=G(e);for(let u=0;u<v;u++)for(let m=0;m<v;m++)r[u][m]===t?n+=c:r[u][m]===s&&(n-=c)}if(i.considerParity){let r=0;for(let u=0;u<e.length;u++)e[u]===D&&r++;if(r<=16){const u=F(e),m=t===B?u.white-u.black:u.black-u.white;n+=l*Math.sign(m)}}if(i.penalizeXSquare){const r=[[1,1],[6,1],[1,6],[6,6]];for(const[u,m]of r)e[h(u,m)]===t&&(n-=f),e[h(u,m)]===s&&(n+=f)}if(i.avoidCornerTrap){const r=[[0,1],[1,0],[1,1],[0,6],[1,7],[1,6],[6,0],[6,1],[7,1],[6,6],[6,7],[7,6]];for(const[u,m]of r)e[h(u,m)]===t&&(n-=p),e[h(u,m)]===s&&(n+=p)}return n}const v=8,D=0,w=1,B=2,S={visible:!0,depth:2,weights:[[100,-25,10,5,5,10,-25,100],[-25,-50,1,1,1,1,-50,-25],[10,1,3,2,2,3,1,10],[5,1,2,1,1,2,1,5],[5,1,2,1,1,2,1,5],[10,1,3,2,2,3,1,10],[-25,-50,1,1,1,1,-50,-25],[100,-25,10,5,5,10,-25,100]],parityWeight:40,stableStoneBonus:20,xSquarePenalty:30,trapPenalty:30,endgame:{maxEmpty:12,usePruning:!0}},Z={1:{visible:!0,name:"弱",comment:"浅い読みとシンプルな評価（初心者向け）",type:"minimax",depth:1,evaluator:W},2:{visible:!0,name:"中",comment:"標準的な深さのミニマックス探索",type:"minimax",depth:2,evaluator:W},3:{visible:!0,name:"強",comment:"さらに深い探索で安定したプレイ",type:"minimax",depth:3,evaluator:W},4:{visible:!0,name:"最強",comment:"深さ6の高精度ミニマックス探索（実践向け）",type:"minimax",depth:6,evaluator:T,useWeights:!1,avoidCornerTrap:!0,penalizeXSquare:!0},101:{visible:!0,name:"AI Test1",comment:"戦略評価を導入",type:"minimax",depth:8,evaluator:T,useWeights:!0,avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0},102:{visible:!0,name:"AI Test2",comment:"残りマス数に応じて深さを調整（動的読み）",type:"minimax",dynamicDepth:!0,depthTable:[{max:20,depth:7},{max:40,depth:5},{max:64,depth:4}],evaluator:T,useWeights:!0,avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0},103:{visible:!0,name:"AI Test3",comment:"反復深化探索（時間制限あり）",type:"iterative",timeLimit:1e3,evaluator:T,useWeights:!0,avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0},104:{visible:!0,name:"AI Test4",comment:"MCTS（モンテカルロ木探索）を使用",type:"mcts",simulations:1e3,timeLimit:800,explorationConstant:1.1,evaluator:q,useWeights:!0,avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0,parityWeight:50,stableStoneBonus:30,xSquarePenalty:60},105:{visible:!1,name:"AI Test5",comment:"評価カスタムを実装",type:"minimax",dynamicDepth:!0,depthTable:[{max:20,depth:8},{max:40,depth:6},{max:64,depth:5}],evaluator:q,useWeights:!0,weights:[[100,-40,20,5,5,20,-40,100],[-40,-80,-1,-1,-1,-1,-80,-40],[20,-1,5,1,1,5,-1,20],[5,-1,1,0,0,1,-1,5],[5,-1,1,0,0,1,-1,5],[20,-1,5,1,1,5,-1,20],[-40,-80,-1,-1,-1,-1,-80,-40],[100,-40,20,5,5,20,-40,100]],avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0,parityWeight:40,stableStoneBonus:20,xSquarePenalty:50,useEndgameSolver:!0,endgame:{maxEmpty:12,usePruning:!0}},106:{visible:!0,name:"AI Test6",comment:"残り12マスになると完全終局読みを使用",type:"minimax",dynamicDepth:!0,depthTable:[{max:20,depth:8},{max:40,depth:6},{max:64,depth:5}],evaluator:T,useWeights:!0,avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0,useEndgameSolver:!0,endgame:{maxEmpty:12,usePruning:!0}},999:{visible:!0,name:"Noob",comment:"最深読みと戦略フル活用。",type:"minimax",dynamicDepth:!0,depthTable:[{max:20,depth:10},{max:40,depth:8},{max:64,depth:6}],evaluator:q,useWeights:!0,weights:[[100,-40,20,5,5,20,-40,100],[-40,-80,-1,-1,-1,-1,-80,-40],[20,-1,5,1,1,5,-1,20],[5,-1,1,0,0,1,-1,5],[5,-1,1,0,0,1,-1,5],[20,-1,5,1,1,5,-1,20],[-40,-80,-1,-1,-1,-1,-80,-40],[100,-40,20,5,5,20,-40,100]],avoidCornerTrap:!0,evaluateStableStones:!0,considerParity:!0,penalizeXSquare:!0,parityWeight:60,stableStoneBonus:30,xSquarePenalty:60,trapPenalty:40,useEndgameSolver:!0,endgame:{maxEmpty:14,usePruning:!0}}},E=new Map,P=new Map;function L(e){let t="";for(let i=0;i<e.length;i++)t+=e[i];return t}function H(e,t){const i=y(t,e);for(const s of i){const n=g(e,s,t),{black:o,white:a}=k(n);if(t===w&&a===0||t===B&&o===0)return s}return null}function K(e,t,i){const s=Z[i]||Z[1],n={...S,...s,endgame:{...S.endgame,...s.endgame||{}}},o=l=>n.evaluator(l,t,n);let a=0;for(let l=0;l<e.length;l++)e[l]===0&&a++;const c=H(e,t);if(c)return c;if(n.useEndgameSolver&&n.endgame&&a<=(n.endgame.maxEmpty??12))return U(e,t,n);if(n.type==="minimax"){const l=n.dynamicDepth?V(a,n.depthTable||[]):n.depth??S.depth??2;return Y(e,t,l,o)}return n.type==="iterative"?O(e,t,n.timeLimit||1e3,o):n.type==="mcts"?Q(e,t,n):null}function V(e,t){for(let i of t)if(e<=i.max)return i.depth;return 2}function Y(e,t,i,s,n){const o=y(t,e);if(o.length===0)return null;let a=null,c=-1/0;for(const l of o){const f=I(e,l,t),p=C(e,3-t,i-1,-1/0,1/0,!1,s);M(e,f),p>c&&(c=p,a=l)}return a}function C(e,t,i,s,n,o,a,c){const l=L(e)+t+i;if(E.has(l))return E.get(l);const f=y(t,e);if(i===0||f.length===0){const r=a(e);return E.set(l,r),r}const p=f.map(r=>{const u=g(e,r,t),m=a(u);return{move:r,score:m}}).sort((r,u)=>o?u.score-r.score:r.score-u.score);if(o){let r=-1/0;for(const{move:u}of p){const m=I(e,u,t),d=C(e,3-t,i-1,s,n,!1,a);if(M(e,m),r=Math.max(r,d),s=Math.max(s,d),n<=s)break}return E.set(l,r),r}else{let r=1/0;for(const{move:u}of p){const m=I(e,u,t),d=C(e,3-t,i-1,s,n,!0,a);if(M(e,m),r=Math.min(r,d),n=Math.min(n,d),n<=s)break}return E.set(l,r),r}}function O(e,t,i,s,n){const o=y(t,e);let a=null,c=-1/0;const l=Date.now();let f=1;for(;Date.now()-l<i;){for(const p of o){const r=I(e,p,t),u=C(e,3-t,f,-1/0,1/0,!1,s);M(e,r),u>c&&(c=u,a=p)}f++}return a}function U(e,t,i){const s=y(t,e);if(s.length===0)return null;let n=null,o=-1/0;const a=s.map(c=>{const l=g(e,c,t),f=i.evaluator(l,t,i);return{move:c,score:f}}).sort((c,l)=>l.score-c.score);for(const{move:c}of a){const l=I(e,c,t),f=-$(e,3-t,i,!1,-1/0,1/0);M(e,l),f>o&&(o=f,n=c)}return n}function $(e,t,i,s,n=-1/0,o=1/0){var p;const a=L(e)+t;if(P.has(a))return P.get(a);const c=y(t,e);if(c.length===0)if(y(3-t,e).length===0){let u=0,m=0;for(let x=0;x<e.length;x++)e[x]===w?u++:e[x]===B&&m++;const d=t===w?u-m:m-u;return P.set(a,d),d}else{const u=-$(e,3-t,i,!0,-o,-n);return P.set(a,u),u}const l=c.map(r=>{const u=g(e,r,t),m=i.evaluator(u,t,i);return{move:r,score:m}}).sort((r,u)=>u.score-r.score);let f=-1/0;for(const{move:r}of l){const u=I(e,r,t),m=-$(e,3-t,i,!1,-o,-n);if(M(e,u),f=Math.max(f,m),n=Math.max(n,m),n>=o||(p=i.endgame)!=null&&p.usePruning&&f>=64)break}return P.set(a,f),f}function j(e,t){let i=-1/0,s=e.children[0];for(const n of e.children){const o=n.visits===0?1/0:n.wins/n.visits+t*Math.sqrt(Math.log(e.visits)/n.visits);o>i&&(i=o,s=n)}return s}function J(e,t,i){let s=e.slice(),n=t;for(;;){const c=y(n,s);if(c.length===0){if(y(3-n,s).length===0)break;n=3-n;continue}const l=c[Math.floor(Math.random()*c.length)];s=g(s,l,n),n=3-n}const{black:o,white:a}=k(s);return i===w?o>a?1:o===a?.5:0:a>o?1:a===o?.5:0}function Q(e,t,i){const s=i.timeLimit??1e3,n=i.simulations??1e3,o=i.explorationConstant??1.4,a={board:e,children:[],untried:y(t,e),wins:0,visits:0,color:t},c=Date.now();let l=0;for(;Date.now()-c<s&&l<n;){let r=a;for(;r.untried.length===0&&r.children.length>0;)r=j(r,o);if(r.untried.length>0){const d=Math.floor(Math.random()*r.untried.length),x=r.untried.splice(d,1)[0],X=g(r.board,x,r.color),z={board:X,move:x,parent:r,children:[],untried:y(3-r.color,X),wins:0,visits:0,color:3-r.color};r.children.push(z),r=z}const u=J(r.board,r.color,t);let m=r;for(;m;)m.visits+=1,m.wins+=u,m=m.parent;l++}let f=null,p=-1;for(const r of a.children)r.visits>p&&(p=r.visits,f=r.move??null);return f}self.onmessage=function(e){const{board:t,turn:i,level:s}=e.data,n=K(t,i,s);postMessage(n)}})();
